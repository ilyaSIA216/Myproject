<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiaMatch - –û—Ç–ª–∞–¥–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-blue { background: #2196F3; }
        .btn-red { background: #f44336; }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –û—Ç–ª–∞–¥–∫–∞ SiaMatch</h1>
        
        <div class="section">
            <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h2>
            <button class="btn" onclick="checkAllStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button class="btn btn-blue" onclick="clearAndTest()">–û—á–∏—Å—Ç–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button>
            <div id="storage-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>2. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏</h2>
            <button class="btn" onclick="testSubmit()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É</button>
            <button class="btn btn-blue" onclick="testMultiple()">5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</button>
            <div id="submit-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</h2>
            <button class="btn" onclick="checkAdminPanel()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω–∞</button>
            <button class="btn btn-blue" onclick="window.open('admin.html', '_blank')">–û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
            <div id="admin-log" class="log"></div>
        </div>
        
        <div class="section">
            <h2>4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h2>
            <button class="btn" onclick="repairAll()">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button class="btn btn-red" onclick="clearAll()">–û–ß–ò–°–¢–ò–¢–¨ –í–°–Å</button>
            <div id="repair-log" class="log"></div>
        </div>
    </div>

    <script>
        function logTo(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = message + '\n\n' + element.innerHTML;
            console.log(message);
        }
        
        function checkAllStorage() {
            logTo('storage-log', '=== üîç –ü–†–û–í–ï–†–ö–ê –•–†–ê–ù–ò–õ–ò–©–ê ===');
            
            const keys = [
                'sia_current_user',
                'sia_current_user_id', 
                'sia_pending_users',
                'sia_active_users',
                'sia_admin_notifications',
                'sia_admin_session',
                'sia_admin_log'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        const count = Array.isArray(parsed) ? parsed.length : '–æ–±—ä–µ–∫—Ç';
                        logTo('storage-log', `‚úÖ ${key}: ${count} (${value.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
                        
                        if (key === 'sia_pending_users' && Array.isArray(parsed)) {
                            parsed.forEach((app, i) => {
                                logTo('storage-log', `   ${i+1}. ${app.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${app.status || '–Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞'})`);
                            });
                        }
                    } catch (e) {
                        logTo('storage-log', `‚ùå ${key}: –û–®–ò–ë–ö–ê –ü–ê–†–°–ò–ù–ì–ê - ${e.message}`);
                    }
                } else {
                    logTo('storage-log', `üì≠ ${key}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö`);
                }
            });
            
            logTo('storage-log', '=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===');
        }
        
        function testSubmit() {
            logTo('submit-log', '=== üì§ –¢–ï–°–¢ –û–¢–ü–†–ê–í–ö–ò –ó–ê–Ø–í–ö–ò ===');
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const testUser = {
                id: Date.now(),
                name: "–¢–µ—Å—Ç " + Math.floor(Math.random() * 1000),
                age: 20 + Math.floor(Math.random() * 20),
                city: ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ö–∞–∑–∞–Ω—å", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"][Math.floor(Math.random() * 4)],
                gender: Math.random() > 0.5 ? "male" : "female",
                bio: "–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –∏–∑ –æ—Ç–ª–∞–¥–∫–∏ " + new Date().toLocaleTimeString(),
                mainPhoto: "https://via.placeholder.com/150?text=–§–æ—Ç–æ",
                selfie: "https://via.placeholder.com/150?text=–°–µ–ª—Ñ–∏"
            };
            
            logTo('submit-log', `–°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${testUser.name}, ${testUser.age} –ª–µ—Ç, ${testUser.city}`);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            localStorage.setItem('sia_current_user', JSON.stringify(testUser));
            localStorage.setItem('sia_current_user_id', testUser.id.toString());
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É
            const newApplication = {
                id: testUser.id,
                name: testUser.name,
                age: testUser.age,
                city: testUser.city,
                gender: testUser.gender,
                bio: testUser.bio,
                status: 'pending',
                submittedAt: new Date().toISOString(),
                applicationId: 'APP-' + Date.now().toString().slice(-8),
                mainPhoto: testUser.mainPhoto,
                selfie: testUser.selfie
            };
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞—è–≤–∫–∏
            let pendingUsers = [];
            try {
                const stored = localStorage.getItem('sia_pending_users');
                if (stored) {
                    pendingUsers = JSON.parse(stored);
                }
            } catch (e) {
                logTo('submit-log', '‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞—è–≤–æ–∫');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
            const existingIndex = pendingUsers.findIndex(u => u.id === testUser.id);
            if (existingIndex !== -1) {
                pendingUsers[existingIndex] = newApplication;
                logTo('submit-log', '‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            } else {
                pendingUsers.push(newApplication);
                logTo('submit-log', '‚úÖ –ó–∞—è–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            try {
                localStorage.setItem('sia_pending_users', JSON.stringify(pendingUsers));
                logTo('submit-log', `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∑–∞—è–≤–æ–∫: ${pendingUsers.length}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                const verify = localStorage.getItem('sia_pending_users');
                if (verify) {
                    const parsed = JSON.parse(verify);
                    logTo('submit-log', `‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: ${parsed.length} –∑–∞—è–≤–æ–∫ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ`);
                }
            } catch (e) {
                logTo('submit-log', `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${e.message}`);
            }
            
            logTo('submit-log', '=== –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù ===');
        }
        
        function testMultiple() {
            logTo('submit-log', '=== üì§ –û–¢–ü–†–ê–í–ö–ê 5 –¢–ï–°–¢–û–í–´–• –ó–ê–Ø–í–û–ö ===');
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    testSubmit();
                }, i * 500);
            }
        }
        
        function checkAdminPanel() {
            logTo('admin-log', '=== üë®‚Äçüíº –ü–†–û–í–ï–†–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò ===');
            
            try {
                const stored = localStorage.getItem('sia_pending_users');
                if (!stored) {
                    logTo('admin-log', '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞—è–≤–∫–∞—Ö –≤ localStorage');
                    return;
                }
                
                const pendingUsers = JSON.parse(stored);
                logTo('admin-log', `üìä –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: ${pendingUsers.length}`);
                
                if (pendingUsers.length === 0) {
                    logTo('admin-log', 'üì≠ –ó–∞—è–≤–æ–∫ –Ω–µ—Ç');
                    return;
                }
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                const stats = {
                    pending: pendingUsers.filter(u => u.status === 'pending').length,
                    approved: pendingUsers.filter(u => u.status === 'approved').length,
                    rejected: pendingUsers.filter(u => u.status === 'rejected').length
                };
                
                logTo('admin-log', `üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ - ${stats.pending}, –æ–¥–æ–±—Ä–µ–Ω–æ - ${stats.approved}, –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ - ${stats.rejected}`);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –∑–∞—è–≤–æ–∫
                logTo('admin-log', 'üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏:');
                pendingUsers.slice(-5).forEach((app, i) => {
                    logTo('admin-log', `${i+1}. ${app.name}, ${app.age} –ª–µ—Ç, ${app.city} - ${app.status || 'pending'} (ID: ${app.id})`);
                });
                
            } catch (e) {
                logTo('admin-log', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            }
            
            logTo('admin-log', '=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===');
        }
        
        function repairAll() {
            logTo('repair-log', '=== üîß –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• ===');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É sia_pending_users
            try {
                const stored = localStorage.getItem('sia_pending_users');
                let pendingUsers = [];
                
                if (stored && stored !== 'undefined' && stored !== 'null') {
                    pendingUsers = JSON.parse(stored);
                }
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏
                const repairedUsers = pendingUsers.map(user => {
                    return {
                        id: user.id || Date.now() + Math.random(),
                        name: user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
                        age: user.age || 25,
                        city: user.city || '–ù–µ —É–∫–∞–∑–∞–Ω',
                        gender: user.gender || 'unknown',
                        bio: user.bio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SiaMatch',
                        status: user.status || 'pending',
                        submittedAt: user.submittedAt || new Date().toISOString(),
                        applicationId: user.applicationId || 'APP-' + Date.now().toString().slice(-6),
                        mainPhoto: user.mainPhoto || '',
                        selfie: user.selfie || '',
                        hasMainPhoto: user.hasMainPhoto || !!user.mainPhoto,
                        hasSelfie: user.hasSelfie || !!user.selfie
                    };
                });
                
                localStorage.setItem('sia_pending_users', JSON.stringify(repairedUsers));
                logTo('repair-log', `‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${repairedUsers.length} –∑–∞—è–≤–æ–∫`);
                
            } catch (e) {
                logTo('repair-log', `‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${e.message}`);
                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                localStorage.setItem('sia_pending_users', '[]');
                logTo('repair-log', '‚úÖ –°–æ–∑–¥–∞–Ω –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞—è–≤–æ–∫');
            }
            
            logTo('repair-log', '=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ===');
        }
        
        function clearAndTest() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ?')) {
                localStorage.clear();
                logTo('storage-log', 'üßπ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
                
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
                setTimeout(() => {
                    testMultiple();
                    setTimeout(() => {
                        checkAllStorage();
                    }, 1000);
                }, 500);
            }
        }
        
        function clearAll() {
            if (confirm('–¢–û–ß–ù–û –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                localStorage.clear();
                logTo('repair-log', '‚ö†Ô∏è –í–°–ï –î–ê–ù–ù–´–ï –û–ß–ò–©–ï–ù–´');
            }
        }
        
        // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkAllStorage();
        });
    </script>
</body>
</html>

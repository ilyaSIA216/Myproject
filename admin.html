<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiaMatch - Админ панель</title>
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ВСЕ ОРИГИНАЛЬНЫЕ СТИЛИ БЕЗ ИЗМЕНЕНИЙ */
        body {
            background: linear-gradient(135deg, #1a237e, #283593);
        }
        
        .admin-container {
            background: white;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 1000px;
            width: 100%;
            min-height: 90vh;
            position: relative;
        }
        
        /* ... остальные стили без изменений ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-container" id="admin-container">
            <!-- Заглушка пока загружается -->
            <div id="loading" style="text-align: center; padding: 100px;">
                <div style="font-size: 48px; color: #4CAF50; margin-bottom: 20px;">⏳</div>
                <div style="color: #666;">Загрузка админ-панели...</div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для фото -->
    <div id="photo-modal" class="photo-modal">
        <button class="close-modal" onclick="closePhotoModal()">×</button>
        <img id="modal-image" src="" alt="Увеличенное фото">
    </div>

    <script>
        // Проверка авторизации админа
        function checkAdminAuth() {
            const session = localStorage.getItem('sia_admin_session');
            const loginTime = localStorage.getItem('sia_admin_login_time');
            
            if (!session || session !== 'active') {
                window.location.href = 'admin-login.html';
                return false;
            }
            
            // Проверка времени сессии (8 часов)
            const loginDate = new Date(loginTime);
            const now = new Date();
            const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
            
            if (hoursDiff > 8) {
                localStorage.removeItem('sia_admin_session');
                localStorage.removeItem('sia_admin_login_time');
                window.location.href = 'admin-login.html';
                return false;
            }
            
            return true;
        }
        
        // Основной скрипт админ-панели
        function initAdminPanel() {
            if (!checkAdminAuth()) return;
            
            // ЗАГРУЖАЕМ ДАННЫЕ С ПРОВЕРКОЙ ОШИБОК
            let pendingUsers = [];
            try {
                const stored = localStorage.getItem('sia_pending_users');
                console.log('Загружаем данные, длина:', stored?.length || 0);
                
                if (stored && stored !== 'undefined') {
                    pendingUsers = JSON.parse(stored);
                    console.log('Успешно загружено заявок:', pendingUsers.length);
                } else {
                    console.log('Нет данных о заявках или undefined');
                }
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
                pendingUsers = [];
            }
            
            // Статистика
            const stats = {
                pending: pendingUsers.filter(u => u.status === 'pending').length,
                approved: pendingUsers.filter(u => u.status === 'approved').length,
                rejected: pendingUsers.filter(u => u.status === 'rejected').length,
                total: pendingUsers.length
            };
            
            console.log('Статистика:', stats);
            
            // Генерация HTML
            document.getElementById('admin-container').innerHTML = `
                <div class="admin-header">
                    <div class="admin-title">
                        <i class="fas fa-shield-alt"></i>SiaMatch Admin Panel
                    </div>
                    <div class="admin-info">
                        <div>Администратор</div>
                        <button class="logout-btn" onclick="logoutAdmin()">
                            <i class="fas fa-sign-out-alt"></i> Выйти
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Всего заявок</div>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-value">${stats.pending}</div>
                        <div class="stat-label">На проверке</div>
                    </div>
                    <div class="stat-card approved">
                        <div class="stat-value">${stats.approved}</div>
                        <div class="stat-label">Одобрено</div>
                    </div>
                    <div class="stat-card rejected">
                        <div class="stat-value">${stats.rejected}</div>
                        <div class="stat-label">Отклонено</div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="showTab('pending')">
                        <i class="fas fa-clock"></i>На проверке (${stats.pending})
                    </button>
                    <button class="tab-btn" onclick="showTab('approved')">
                        <i class="fas fa-check-circle"></i>Одобренные (${stats.approved})
                    </button>
                    <button class="tab-btn" onclick="showTab('rejected')">
                        <i class="fas fa-times-circle"></i>Отклоненные (${stats.rejected})
                    </button>
                    <button class="tab-btn" onclick="showTab('logs')">
                        <i class="fas fa-history"></i>Логи доступа
                    </button>
                </div>
                
                <div id="pending-tab" class="tab-content active">
                    <div class="search-box">
                        <input type="text" id="search-pending" placeholder="Поиск по имени или городу..." onkeyup="searchApplications('pending')">
                    </div>
                    <div class="applications-list" id="pending-list">
                        <!-- Список заявок на проверке -->
                    </div>
                </div>
                
                <div id="approved-tab" class="tab-content">
                    <div class="search-box">
                        <input type="text" id="search-approved" placeholder="Поиск по имени или городу..." onkeyup="searchApplications('approved')">
                    </div>
                    <div class="applications-list" id="approved-list">
                        <!-- Список одобренных -->
                    </div>
                </div>
                
                <div id="rejected-tab" class="tab-content">
                    <div class="search-box">
                        <input type="text" id="search-rejected" placeholder="Поиск по имени или городу..." onkeyup="searchApplications('rejected')">
                    </div>
                    <div class="applications-list" id="rejected-list">
                        <!-- Список отклоненных -->
                    </div>
                </div>
                
                <div id="logs-tab" class="tab-content">
                    <h3>Логи входа в админ-панель</h3>
                    <div class="logs-container" id="logs-list">
                        <!-- Логи будут здесь -->
                    </div>
                </div>
            `;
            
            // Загружаем данные в табы
            loadApplications('pending');
            loadApplications('approved');
            loadApplications('rejected');
            loadLogs();
            
            // Скрываем загрузку
            document.getElementById('loading').style.display = 'none';
        }
        
        // ... остальные функции без изменений ...
        
        // Запускаем админ-панель при загрузке
        document.addEventListener('DOMContentLoaded', initAdminPanel);
        
        // Закрытие модального окна по клику вне фото
        document.getElementById('photo-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoModal();
            }
        });
        
        // Закрытие модального окна по Esc
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoModal();
            }
        });
    </script>
</body>
</html>
